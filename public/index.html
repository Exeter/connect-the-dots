<html>
<head>
<title>Graph visualization</title>
<style type="text/css">
body {
	margin: 0;
	padding: 0;
	overflow: hidden;
	font-family: Monaco, "DejaVu Sans Mono", "Lucida Console", monospace;
	font-size: 10px;
	background-color: #000000;
}
#bar {
	position: absolute;
	top: 0;
	right: 0;
	width: 200px;
	display: inline;
	z-index: 2;
}
#graph {
	position: fixed;
	top: 0; left: 0;
	height: 100%;
	width: 100%;
	background-color: #000000;
}
.box {
	padding: 5px;
	background-color: #252726;
	box-shadow: 2px 2px 1px #000;
	color: white;
}
.legend {
	position: absolute;
}
.nodetext{
	color: #fff;
}

.edge {
	stroke: #999;
	stroke-width: 1;
	stroke-opacity: .2;
	z-index: 1;
}
.node {
	z-index: 0;
}
</style>
</head>
<body>
<script src="./d3.v3.min.js"></script>
<script src="./jquery-1.9.1.min.js"></script>
<div id="bar" class="box">
	<form onsubmit="return false">
		Search:<input type="text" id="search">
	</form>
</div>
<script>

$(document).ready(function(){
	indexof = {};
	data = {};
	var svg;

	d3.json("./graphdata.json", function(err, info){
		if (err) return console.warn(err);

		/* Data Preparation */

		data['nodes'] = [];

		var filterstatus = {
		// 	'category': (is filtered out)
			'mus': true,
			'pec': true,
		}
		function dontwantcourse(course){
			if (course['subject'] == 'pec') return filterstatus['pec'];
			if (course['subject'] == 'mus') return filterstatus['mus'];
			return false;
		}

		var nodeindex = 0;
		/* init student nodes */
		for (username in info.students){
			var student  = info.students[username];
			student['name'] = student.FirstName + ' ' + student.LastName;
			student['type'] = 'student';
			var neighbors = [];
			if ('Courses' in student){
				for (i in student['Courses']){
					var course = student['Courses'][i];
					course = course.substring(course.lastIndexOf("/") + 1);
					neighbors.push(course);
				}
			}
			student['neighbors'] = neighbors;

			data['nodes'].push(student);

			indexof[student['key']] = nodeindex;
			nodeindex += 1;
		}
		/* init course nodes */
		for (coursename in info.courses){
			var course = info.courses[coursename];
			if (dontwantcourse(course)) continue;
			course['neighbors'] = course['members'];
			course['type'] = 'course'; //type? nodetype? as a css attr?
			data['nodes'].push(course);

			indexof[course['key']] = nodeindex;
			nodeindex += 1;
		}

		/* init edges */
		data['edges'] = [];
		for (coursename in info.courses){
			var course = info.courses[coursename]
			if (dontwantcourse(course)) continue;
			for ( i in course['neighbors']){
				edge = {};
				edge = {'source': indexof[course['key']], 'target': indexof[course['neighbors'][i]]};
				edge['nodes'] = [course['key'], course['neighbors'][i]];
				data['edges'].push(edge);
			}
		}
		svg = d3.select('body').append('svg')
			.attr("id", 'graph')
			.attr("width", document.body.clientWidth)
			.attr("height", document.body.clientHeight)
			.attr("pointer-events", "all")
			.append('g')
			.call(d3.behavior.zoom()
				.scaleExtent([0.20,5])
				.on("zoom", zoomed))
			.append('g');
		function zoomed() {
			svg.attr("transform",
			"translate(" + d3.event.translate + ")"
			+ " scale(" + d3.event.scale + ")");
		}
		visualize();

	});

	var color_code = function(category){
		this.Grade = {
			'9': '#46aede',
			'10': '#94e76b',
			'11': '#ffac18',
			'12': '#e32c57'
		}
		return this[category];
	}

	/* Visualization */
	function visualize(){
		var force = d3.layout.force()
			.gravity(1)
			.charge(-400)
			.linkDistance(1)
			.friction(0.95)
			.alpha(10)
			.size([document.body.clientWidth, document.body.clientHeight]);

		force
			.nodes(data.nodes)
			.links(data.edges)
			.start();

		var edge = svg.selectAll('.edge')
			.data(data.edges)
			.enter().append('line')
			.attr('highlighted', false)
			.attr('class', function(d){
			     return ['edge', d.nodes[0], d.nodes[1]].join(' ');
			});
		var node = svg.selectAll('.node')
			.data(data.nodes)
			.enter().append('circle')
			.attr('highlighted', false)
			.attr('id', function(d){
				return d.key;
			})
			.attr('class', function(d){
				var classes = [];
				if ('neighbors' in d) classes = d.neighbors;
				classes.push('node');
				return classes.join(' ');
			})
			.attr('nodetype', function(d){
				return d.type;
			})
			.on("mouseover", highlight)
			.on("mouseout", resethighlight);
		svg.selectAll('[nodetype=student]')
			.attr('r', 3);
		svg.selectAll('[nodetype=course]')
			.attr('r', 5);
			

		resethighlight();
		node.append("title")
			.text(function(d) {return d.name});

		force.on('tick', function(){
			edge.attr('x1', function(d) { return d.source.x; })
				.attr('y1', function(d) { return d.source.y; })
				.attr("x2", function(d) { return d.target.x; })
				.attr("y2", function(d) { return d.target.y; });
			node.attr('cx', function(d) { return d.x; })
				.attr("cy", function(d) { return d.y; });
		});

	}
	function resethighlight(){
		d3.selectAll('.edge[highlighted=true]')
			.attr('highlighted', false)
			.transition()
			.duration(1000)
			.style('stroke-opacity', '.2');
		d3.selectAll('[nodetype=course]')
			.attr('highlighted', false)
			.transition()
			.duration(1000)
			.style('fill', '#000')
			.style('opacity', 0.8);
		d3.selectAll('[nodetype=student]')
			.attr('highlighted', false)
			.transition()
			.duration(1000)
			.style('fill', function(d){
				return color_code("Grade")[d.Grade];
			})
			.style('opacity', 1);
	}
	function highlight(d){
		d3.selectAll('.' + d.key + ', #' + d.key)
			.attr('highlighted', true)
			.transition()
			.duration(750)
			.style('fill', "fff")
			.style('opacity', "1")
			.style('stroke-opacity', "1");
		d3.selectAll('.node[highlighted=false]')
			.attr('highlighted', true)
			.transition()
			.duration(750)
			.style('opacity', "0.1");
	}
	var timeout;
	$("#search").keyup(function() {
		var query = $(this).val();
		window.clearTimeout(timeout);
		timeout = setTimeout(function(){
			console.log(query);
			d3.selectAll('.node')
				.filter(function(b,i) {
					if (b.key == query) return i;
					return null;
				})
				.each(function(b, i) {
					highlight(b);
				});

		}, 1000);


		
	});
});
</script>
</body>
</html>
